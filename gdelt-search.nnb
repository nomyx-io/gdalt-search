{
    "cells": [
        {
            "language": "markdown",
            "source": [
                "# Calling Open-AI API\n\nthe following function lets us call the Open AI API and get the response from the API"
            ],
            "outputs": []
        },
        {
            "language": "typescript",
            "source": [
                "import 'dotenv';\nimport axios from 'axios';\nimport { Buffer } from 'buffer';\nimport { jsonrepair } from 'jsonrepair'\n\nfunction calculatePayloadSize(payload: any): number {\n    return Buffer.byteLength(JSON.stringify(payload), 'utf8');\n}\nasync function sendRequest(request: any): Promise<any> {\n    let response: any = null;\n    let payload = {\n        model: 'gpt-4',\n        max_tokens: 8192,\n        temperature: 1,\n        top_p: 1,\n        messages: [{\n            role: 'user',\n            content: request\n        }]\n    }\n    let payloadSize = calculatePayloadSize(payload);\n    payload.max_tokens = Math.min(8192, Math.max(1, Math.floor(8192 * (payloadSize / 8192))));\n    try {\n        response = await axios.post(\n            'https://api.openai.com/v1/chat/completions',\n            JSON.stringify(payload), {\n            headers: {\n                'Content-Type': 'application/json',\n                'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,\n            },\n        });\n        if(!response) throw new Error('No response');\n        if (response.data && response.data.choices && response.data.choices.length > 0) {\n            response = response.data.choices[0].message.content;\n        } else {\n            throw new Error('No completion found');\n        }\n    } catch (error: any) { throw error;  }\n    return response;\n};\n\n// returns a function that can be called to send a request to the AI. the prompt defines the main\n// prompt that will be sent to the AI. The prompt may contain a mumber of replacement markers.\n// the markers are defined as {0}, {1}, {2}, etc. The function returns a function that takes parameters\n// that will replace the markers in the prompt. The function returns a promise that resolves to the\n// response from the AI.\nfunction createAIFunction(prompt: any) {\n    return function (...args: any[]) {\n        let request = prompt;\n        for (let i = 0; i < args.length; i++) {\n            request = request.replace(`{${i}}`, args[i]);\n        }\n        return sendRequest(request);\n    }\n}\n\nconst aiFunction = createAIFunction('Create a {0} that {1}.');\n\naiFunction('function', 'returns the sum of two numbers').then(console.log);\n\nasync function performTask(_task: string, format: string, input: any = null) {\n    input = input ? `Input: ${input}` : '';\n    return new Promise((resolve, reject) => {\n        const prompt = `You are a non-conversational application development agent. You perform the following task then output its result in the given JSON format:\n        Task: ${_task}\n        Format: ${format}\n        ${input}\n        \\n** You must return all your output using JSON format ${format} **\\n`\n        sendRequest(prompt).then((res) => {\n            try {\n                resolve(JSON.parse(jsonrepair(res)));\n            }\n            catch(e) {\n                console.log('error', e)\n            }\n        }).catch(reject);\n    });\n}\n\n\nconst apiInst = `# GDELT API Cheatsheet\n\n## GDELT GEO 2.0 API Cheatsheet\n\n**Base URL:** https://api.gdeltproject.org/api/v2/geo/geo\n\n**Endpoints:**\n\n- \\`/query\\` - Search by keywords, operators, etc\n- \\`/location\\` - Search by location name\n- \\`/locationcc\\` - Search by country code\n- \\`/locationadm1\\` - Search by admin1 region\n- \\`/domain\\` - Search by domain\n- \\`/theme\\` - Search by GKG theme\n- \\`/image\\` - Search images\n\n### GEO Query Parameters\n\n- \\`query\\` - keywords, phrases, operators to search for\n- \\`mode\\` - type of map to generate  \n- \\`format\\` - output format\n- \\`timespan\\` - time range to search\n- \\`maxpoints\\` - max locations to return\n- \\`geores\\` - filter results by resolution\n- \\`sortby\\` - sort results by date, tone, etc\n\n### GEO Query Operators\n\n- \\`\"phrase\"\\` - exact phrase match\n- \\`-exclude\\` - exclude keywords\n- \\`domain:\\` - filter by domain\n- \\`location:\\` - filter by location name\n- \\`locationcc:\\` - filter by country code\n- \\`locationadm1:\\` - filter by admin1 region\n- \\`imagetag:\\` - filter images by tag\n- \\`tone:\\` - filter by tone threshold\n- \\`theme:\\` - filter by GKG theme\n\n### GEO Output Formats\n\n- \\`html\\` - interactive map\n- \\`geojson\\` - geojson data\n- \\`csv\\` - csv data\n- \\`rss\\` - rss feed\n- \\`jsonfeed\\` - jsonfeed data\n\n### GEO Examples\n\n- \\`/query?trump\\` - map trump mentions  \n- \\`/image?imagetag:\"protest\"\\` - map protest images\n- \\`/theme?TERROR\\` - map terrorism mentions\n- \\`/domain?bbc.com\\` - map BBC coverage\n\n## GDELT Doc 2.0 API Cheatsheet\n\n**Base URL:** https://api.gdeltproject.org/api/v2/doc/doc\n\n### Doc Endpoints\n\n- \\`/query\\` - Search by keywords, operators, etc\n- \\`/url\\` - Retrieve content by URL\n- \\`/gkg\\` - Search GKG entities\n- \\`/theme\\` - Search by theme\n- \\`/event\\` - Search by event\n- \\`/mention\\` - Search mentions\n\n### Doc Query Parameters\n\n- \\`query\\` - keywords, phrases, operators to search for\n- \\`mode\\` - docs or events mode\n- \\`maxrecords\\` - max results to return\n- \\`orderby\\` - order results by date, tone, etc\n- \\`format\\` - output format\n\n### Doc Query Operators\n\n- \\`\"phrase\"\\` - exact phrase match\n- \\`-exclude\\` - exclude keywords\n- \\`url:\\` - filter by URL\n- \\`domain:\\` - filter by domain\n- \\`theme:\\` - filter by theme\n- \\`event:\\` - filter by event\n- \\`mention:\\` - filter by mention\n- \\`sourcelang:\\` - filter by source language\n\n### Doc Output Formats\n\n- \\`json\\` - json data\n- \\`csv\\` - csv table\n- \\`rss\\` - rss feed\n- \\`jsonfeed\\` - json feed\n\n### Doc Examples\n\n- \\`/query?trump\\` - search for trump\n- \\`/url?https://cnn.com/article\\` - get article by url  \n- \\`/theme?TERROR\\` - search terror theme\n- \\`/event?06232015barackobama\\` - search Obama event\n- \\`/mention?barackobama\\` - search Obama mentions\n\n## Google News API\n\nBase URL: https://newsapi.org/s/google-news-api\n\nThe Google News API provides endpoints to search articles, get headlines, and get everything.\n\nTo search articles:\n\n\\`\\`\\`text\n/v2/everything?q=QUERY&apiKey=${process.env.NEWS_API_KEY}\n\\`\\`\\`\n\n- q parameter specifies search query\n- Returns articles matching the query\n\nTo get top headlines:\n\n\\`\\`\\`text\n/v2/top-headlines?country=us&apiKey=${process.env.NEWS_API_KEY} \n\\`\\`\\`\n\n- country parameter specifies country code\n- Returns current top headlines for that country\n\nTo get all articles:\n\n\\`\\`\\`text\n/v2/everything?apiKey=${process.env.NEWS_API_KEY}\n\\`\\`\\`\n\n- Fetches latest articles from all news sources\n\nParameters:\n\n- q - Search query\n- sources - Filter by news source \n- domains - Filter by domain\n- from - Start date (YYYY-MM-DD)\n- to - End date\n- language - Filter by language code\n\nThe API returns results in JSON format containing headlines, content, metadata etc.\n\n### Examples\n\nhttps://newsapi.org/v2/everything?q=tesla&from=2023-02-01&sortBy=publishedAt&apiKey=${process.env.NEWS_API_KEY}\n\nThis searches for articles about \"tesla\" published after February 1, 2023 and sorts the results by publish date.\n\nTo break it down:\n\n- Base URL: https://newsapi.org/v2/everything\n- q=tesla - Search for articles containing \"tesla\"\n- from=2023-02-01 - Return articles published after Feb 1, 2023\n- sortBy=publishedAt - Sort results by publish date\n- apiKey=YOUR_API_KEY - Pass your API key\n\nYou can also filter by source, domain, language, country and other parameters.\n\nFor example, to only get English articles from the US about Tesla by CNN:\n\n\\`\\`\\`text\nhttps://newsapi.org/v2/everything?q=tesla&from=2023-02-01&language=en&country=us&domains=cnn.com&apiKey=${process.env.NEWS_API_KEY}\n\\`\\`\\`\n\nThe API returns the results in JSON format containing all the article headlines, content, images, etc. \nThis provides a simple way to query the Google News API by keyword, filters, pagination, and sorting using the options available.\n`\nexport async function buildSearchPlan(query: any) {\n    const results = await performTask(`Given the following search APIs:\\n\\n---\\n${apiInst}\\n---\\n\\nand user search query, build a step-by-step search and analysis plan that will best satisfy the user's query. This might involve querying for keywords, performing analysis on the results, performing searches based on the results of other searches, etc. Size and scope each task so that it is performable by you.`, '{ task: string, description: string, step: number }', `USER QUERY: ${query}`);\n    return results;\n}\nexport async function buildSearchQueries(query: any) {\n    const results = await performTask(`Given the following search APIs:\\n\\n---\\n${apiInst}\\n---\\n\\nand user search query, build a series of search API URLS that can be used to search for the user's query.`, 'string[]', `USER QUERY: ${query}`);\n    return results;\n}\n\nexport async function buildSearchQuery(query: any) {\n    const results = await performTask(`Given the following search APIs:\\n\\n---\\n${apiInst}\\n---\\n\\nand search query, build a search API URL that can be used to search for the specified query.`, 'string[]', `SEARCH QUERY: ${query}`);\n    return results;\n}\n\nbuildSearchPlan('Articles with negative sentiment about Donald Trump').then(console.log);\n"
            ],
            "outputs": [
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.error",
                            "value": {
                                "name": "ReferenceError",
                                "message": "exports is not defined",
                                "stack": "    at <Cell 2> [4, 1]\n    at <Cell 2> [260, 46]\n    at Script.runInContext (node:vm:141:12)\n    at Script.runInNewContext (node:vm:146:17)\n    at Object.runInNewContext (node:vm:306:38)\n    at C (/Users/sschepis/.vscode/extensions/donjayamanne.typescript-notebook-2.0.6/out/extension/server/index.js:2:113345)\n    at t.execCode (/Users/sschepis/.vscode/extensions/donjayamanne.typescript-notebook-2.0.6/out/extension/server/index.js:2:114312)\n    at k.<anonymous> (/Users/sschepis/.vscode/extensions/donjayamanne.typescript-notebook-2.0.6/out/extension/server/index.js:2:142156)\n    at k.emit (node:events:513:28)\n    at k.emit (node:domain:489:12)"
                            }
                        }
                    ]
                }
            ]
        }
    ]
}